<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gself Quiz - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Gself Quiz - Admin</h1>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Add New Question</h5>
                <div class="mb-3">
                    <label for="question" class="form-label">Question:</label>
                    <input type="text" class="form-control" id="question" required />
                </div>
                <div id="options-container">
                    <div class="mb-3">
                        <label class="form-label">Options:</label>
                        <input type="text" class="form-control mb-2" placeholder="Option 1" required />
                        <input type="text" class="form-control mb-2" placeholder="Option 2" required />
                    </div>
                </div>
                <button id="add-option" class="btn btn-secondary mb-3">Add Option</button>
                <div class="mb-3">
                    <label for="correct-answer" class="form-label">Correct Answer (index, starting from 0):</label>
                    <input type="number" class="form-control" id="correct-answer" min="0" required />
                </div>
                <button id="push-question" class="btn btn-primary">Push Question & Open</button>
                <button id="clear-question" class="btn btn-warning ms-2">Clear Current Question & Lock</button>
                <button id="reveal-answers" class="btn btn-danger ms-2">Reveal Answers</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Responses</h5>
                <div id="responses-list" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Leaderboard</h5>
                <div id="leaderboard-list" style="max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3" style="z-index: 1080;">
      <div id="toast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div id="toast-body" class="toast-body"></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, remove, onValue, push as dbPush, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBU4ZorIuQETghQhrV3vqS1pUp7tyvrvsQ",
            authDomain: "vendev-cc4bb.firebaseapp.com",
            databaseURL: "https://vendev-cc4bb-default-rtdb.firebaseio.com",
            projectId: "vendev-cc4bb",
            storageBucket: "vendev-cc4bb.firebasestorage.app",
            messagingSenderId: "627823990652",
            appId: "1:627823990652:web:635e0af5eb4fa525def6f9",
            measurementId: "G-S4M7MYH6DC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // DOM Elements
        const questionInput = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const addOptionBtn = document.getElementById('add-option');
        const correctAnswerInput = document.getElementById('correct-answer');
        const pushQuestionBtn = document.getElementById('push-question');
        const clearQuestionBtn = document.getElementById('clear-question');
        const revealAnswersBtn = document.getElementById('reveal-answers');
        const responsesList = document.getElementById('responses-list');
        const leaderboardList = document.getElementById('leaderboard-list');

        // Toast setup
        const toastEl = document.getElementById('toast');
        const toastBody = document.getElementById('toast-body');
        const bsToast = bootstrap.Toast.getOrCreateInstance(toastEl);
        function showToast(message) {
            toastBody.textContent = message;
            bsToast.show();
        }

        // Add option input box
        addOptionBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control mb-2';
            const count = optionsContainer.querySelectorAll('input').length + 1;
            input.placeholder = `Option ${count}`;
            input.required = true;
            optionsContainer.querySelector('div').appendChild(input);
        });

        // Push new question and set quiz phase to "open"
        pushQuestionBtn.addEventListener('click', () => {
            const question = questionInput.value.trim();
            const options = Array.from(optionsContainer.querySelectorAll('input')).map(input => input.value.trim()).filter(val => val);
            const correctAnswer = parseInt(correctAnswerInput.value);

            if (!question || options.length < 2 || isNaN(correctAnswer) || correctAnswer < 0 || correctAnswer >= options.length) {
                showToast('Please fill all fields correctly.');
                return;
            }

            set(ref(db, 'currentQuestion'), {
                question,
                options,
                correctAnswer
            });
            set(ref(db, 'quizState'), {
                phase: 'open',
                timestamp: Date.now()
            });

            showToast('Question pushed and quiz opened for answers!');
        });

        // Clear question and set phase to locked (no answers allowed)
        clearQuestionBtn.addEventListener('click', () => {
            remove(ref(db, 'currentQuestion')).then(() => {
                set(ref(db, 'quizState'), {
                    phase: 'locked',
                    timestamp: Date.now()
                });
                showToast('Question cleared and quiz locked!');
            });
        });

        // Reveal answers (admin button)
        revealAnswersBtn.addEventListener('click', () => {
            set(ref(db, 'quizState'), {
                phase: 'revealed',
                timestamp: Date.now()
            });
            showToast('Answers revealed!');
        });

        // Listen for responses and show them live with color-coded correctness
        const currentQuestionRef = ref(db, 'currentQuestion');
        let currentCorrectAnswer = null;

        onValue(currentQuestionRef, (snapshot) => {
            const questionData = snapshot.val();
            currentCorrectAnswer = questionData ? questionData.correctAnswer : null;
        });

        const responsesRef = ref(db, 'responses');
        onValue(responsesRef, (snapshot) => {
            const data = snapshot.val();
            responsesList.innerHTML = '';
            if (data) {
                Object.values(data).forEach(response => {
                    const item = document.createElement('div');
                    const isCorrect = currentCorrectAnswer !== null && response.answer === currentCorrectAnswer;
                    item.className = isCorrect ? 'alert alert-success mb-1' : 'alert alert-danger mb-1';
                    item.textContent = `${response.name}: Answer #${response.answer} (Locked at ${new Date(response.timestamp).toLocaleTimeString()})`;
                    responsesList.appendChild(item);
                });
            } else {
                responsesList.textContent = "No responses yet.";
            }
        });

        // Leaderboard logic - accumulate points for correct answers and update in realtime
        const scoresRef = ref(db, 'scores');

        function updateLeaderboard(scores) {
            leaderboardList.innerHTML = '';

            const sortedScores = Object.entries(scores || {}).sort((a, b) => b[1] - a[1]);

            if (sortedScores.length === 0) {
                leaderboardList.textContent = "No scores yet.";
                return;
            }

            sortedScores.forEach(([name, points]) => {
                const item = document.createElement('div');
                item.className = 'd-flex justify-content-between border-bottom py-1';
                item.innerHTML = `<strong>${name}</strong><span>${points} point${points !== 1 ? 's' : ''}</span>`;
                leaderboardList.appendChild(item);
            });
        }

        // Update scores from responses and set leaderboard accordingly
        onValue(responsesRef, (snapshot) => {
            const allResponses = snapshot.val();
            if (!allResponses) {
                updateLeaderboard({});
                return;
            }

            get(currentQuestionRef).then(questionSnap => {
                const correctAnswer = questionSnap.val()?.correctAnswer;
                if (correctAnswer === undefined) {
                    updateLeaderboard({});
                    return;
                }

                const scores = {};
                // For each response, count 1 point if locked and correct
                for (const key in allResponses) {
                    const response = allResponses[key];
                    if (response.locked && response.answer === correctAnswer) {
                        scores[response.name] = (scores[response.name] || 0) + 1;
                    }
                }

                // Update scores data in database (optional, useful for persistence)
                set(scoresRef, scores);

                updateLeaderboard(scores);
            });
        });

        // Also update leaderboard UI on scores data change (to sync if changed by other means)
        onValue(scoresRef, (snapshot) => {
            const scores = snapshot.val();
            updateLeaderboard(scores);
        });
    </script>
</body>
</html>
